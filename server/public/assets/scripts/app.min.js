/*! parking_app 2015-06-04 */
var app=angular.module("app",[]);app.controller("IndexController",["$scope","$http","$q",function(a,b,c){function d(){var b=new google.maps.LatLng(a.spot.latitude,a.spot.longitude);k=new google.maps.Map(document.getElementById("map-canvas"),{zoom:14,center:b,mapTypeId:google.maps.MapTypeId.ROADMAP})}a.auth=!1,a.tab=1,a.logIn=function(){console.log("Clicked! sending request",a.login),b.post("/users/login",a.login).success(function(){e()})},a.register=function(){console.log("Clicked! sending request",a.login),b.post("/users/register",a.login).success(function(){a.logIn()})},a.spot={};var e=function(){b.get("/users/username").success(function(b){console.log("user data is",b),b&&(a.user=b,a.auth=!0,a.user.spots[a.user.spots.length-1]&&o({latitude:a.user.spots[a.user.spots.length-1].latitude,longitude:a.user.spots[a.user.spots.length-1].longitude}))})};console.log("Current user is ",a.user);var f=function(){var c={"user._id":a.user._id,spot:a.spot};return console.log("Sending request to save spot:",c),b.post("/spots/add/",c)},g=function(){var c={"user._id":a.user._id,spot:a.spot};return console.log("Sending request to update spot:",c),b.put("/spots/update",c)};a.park=function(){var b=h();b.then(function(b){console.log("Actioning promise"),o(a.spot),f();var c=new google.maps.LatLng(a.spot.latitude,a.spot.longitude);k.setCenter(c),k.setZoom(15)},function(a){console.log("Failed: ",a)})},a.route=function(){var a=h();a.then(function(a){console.log("Actioning promise"),p()},function(a){console.log("Failed: ",a)})};var h=function(){return c(function(a,b){setTimeout(function(){1==j()?a("Position acquired"):b("Could not resolve position")},1e4)})},i=function(b){return console.log("set position",b),a.spot.created=new Date,a.spot.latitude=b.coords.latitude,a.spot.longitude=b.coords.longitude,console.log("spot set to",a.spot),null==k&&d(),!0},j=function(){if(navigator.geolocation)return navigator.geolocation.getCurrentPosition(i),!0;throw new Error("In-browser geolocation not supported")};a.mapStyle={width:"100%"};var k,l=new google.maps.DirectionsService,m=new google.maps.DirectionsRenderer,n=new google.maps.Marker;google.maps.event.addDomListener(window,"load",j);var o=function(b){m.setMap(null),m.setPanel(null),n.setMap(null),n=new google.maps.Marker({position:new google.maps.LatLng(b.latitude,b.longitude),draggable:!0,title:"Parking Spot"}),google.maps.event.addListener(n,"dragend",function(){m.setMap(null),m.setPanel(null);var b=n.getPosition();console.log("new spot is",b),a.spot.latitude=b.A,a.spot.longitude=b.F,a.spot.created=new Date,g(),j()}),n.setMap(k),console.log("Pin dropped",n)},p=function(){var b=document.getElementById("directionsPanel");l.route({origin:new google.maps.LatLng(a.spot.latitude,a.spot.longitude),destination:n.position,travelMode:google.maps.TravelMode.WALKING},function(a,c){c==google.maps.DirectionsStatus.OK&&(m.setDirections(a),m.setMap(k),m.setPanel(b))})}}]);