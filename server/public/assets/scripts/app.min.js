/*! parking_app 2015-05-29 */
var app=angular.module("app",[]);app.factory("geolocation",["$q","$rootScope","$window",function(a,b,c){return{getLocation:function(){var d=a.defer();return c.navigator.geolocation?c.navigator.geolocation.getCurrentPosition(function(a){b.$apply(function(){d.resolve(a)})},function(a){switch(a){case 1:d.reject("Permission denied");break;case 2:d.reject("Position unavailable");break;case 3:d.reject("Request timeout")}},{enableHighAccuracy:!0,timeout:1e4,maximumAge:0}):d.reject("Unsupported browser."),d.promise}}}]),app.controller("IndexController",["$scope","$http","geolocation",function(a,b,c){a.spot={};a.saveSpot=function(){return b.post("/spot",a.spot)},a.park=function(){e().then(function(){i.addPin()},function(a){f(a)},function(a){g(a)}).then(function(){a.saveSpot()},function(a){f(a)},function(a){g(a)})};var d=function(b){return console.log("set position",b),a.spot.created=new Date,a.spot.latitude=b.coords.latitude,a.spot.longitude=b.coords.longitude,console.log("spot set to",a.spot),i.setView([a.spot.latitude,a.spot.longitude],15),!0},e=function(){var a=c.getLocation();return a.then(function(a){d(a)},function(a){f(a)},function(a){g(a)}),a},f=function(a){console.log("Failed: ",a),next(a)},g=function(a){console.log("Update: ",a)};L.mapbox.accessToken="pk.eyJ1Ijoia2FpdGxpbm11dGgiLCJhIjoiNzZmNzg3OTE5N2ExMTgxNTcxYzdiM2RlMGQxN2Q2YzcifQ.YENWVyAaFMg0ngZEc1aP7A";var h=L.mapbox.tileLayer("mapbox.pencil"),i=L.map("map").addLayer(h);e(),i.addPin=function(){L.marker([a.spot.latitude,a.spot.longitude]).addTo(i)},a.mapStyle={width:"100%"}}]);