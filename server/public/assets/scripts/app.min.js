/*! parking_app 2015-05-31 */
var app=angular.module("app",[]);app.controller("IndexController",["$scope","$http","geolocation",function(a,b,c){a.spot={};a.saveSpot=function(){return console.log("Saving spot",a.spot),b.post("/spot",a.spot)},a.park=function(){e().then(function(){i.addPin()},function(a){f(a)},function(a){g(a)}).then(function(){a.saveSpot()},function(a){f(a)},function(a){g(a)})};var d=function(b){return console.log("set position",b),a.spot.created=new Date,a.spot.latitude=b.coords.latitude,a.spot.longitude=b.coords.longitude,console.log("spot set to",a.spot),i.setView([a.spot.latitude,a.spot.longitude],15),!0},e=function(){var a=c.getLocation();return a.then(function(a){d(a)},function(a){f(a)},function(a){g(a)}),a},f=function(a){console.log("Failed: ",a),next(a)},g=function(a){console.log("Update: ",a)};L.mapbox.accessToken="pk.eyJ1Ijoia2FpdGxpbm11dGgiLCJhIjoiNzZmNzg3OTE5N2ExMTgxNTcxYzdiM2RlMGQxN2Q2YzcifQ.YENWVyAaFMg0ngZEc1aP7A";var h=L.mapbox.tileLayer("mapbox.pencil"),i=L.map("map").addLayer(h);e(),i.addPin=function(){L.marker([a.spot.latitude,a.spot.longitude],{draggable:!0}).on("dragend",function(){var b=this.getLatLng();console.log("New Lat/Lng is",b),a.spot.latitude=b.lat,a.spot.longitude=b.lng,a.saveSpot()}).addTo(i)},a.mapStyle={width:"100%"}}]);