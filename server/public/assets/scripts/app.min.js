/*! parking_app 2015-06-01 */
var app=angular.module("app",[]);app.controller("IndexController",["$scope","$http","$sce","geolocation",function(a,b,c,d){a.auth=!1,a.tab=1,a.logIn=function(){console.log("Clicked! sending request",a.login),b.post("/users/login",a.login).success(function(){e()})},a.spot={};var e=function(){b.get("/users/username").success(function(b){console.log("user data is",b),0!=b&&(a.user=b,a.auth=!0)})};console.log("Current user is ",a.user);a.saveSpot=function(){return console.log("Saving spot",a.spot),b.post("/spot",a.spot)},a.park=function(){g().then(function(){k.addPin()},function(a){h(a)},function(a){i(a)}).then(function(){a.saveSpot()},function(a){h(a)},function(a){i(a)})};var f=function(b){return console.log("set position",b),a.spot.created=new Date,a.spot.latitude=b.coords.latitude,a.spot.longitude=b.coords.longitude,console.log("spot set to",a.spot),k.setView([a.spot.latitude,a.spot.longitude],15),!0},g=function(){var a=d.getLocation();return a.then(function(a){f(a)},function(a){h(a)},function(a){i(a)}),a},h=function(a){console.log("Failed: ",a),next(a)},i=function(a){console.log("Update: ",a)};L.mapbox.accessToken="pk.eyJ1Ijoia2FpdGxpbm11dGgiLCJhIjoiNzZmNzg3OTE5N2ExMTgxNTcxYzdiM2RlMGQxN2Q2YzcifQ.YENWVyAaFMg0ngZEc1aP7A";var j=L.mapbox.tileLayer("mapbox.streets"),k=L.map("map").addLayer(j);k.attributionControl.setPosition("bottomleft"),g(),k.addPin=function(){L.marker([a.spot.latitude,a.spot.longitude],{draggable:!0}).on("dragend",function(){var b=this.getLatLng();a.spot.latitude=b.lat,a.spot.longitude=b.lng,a.saveSpot()}).addTo(k)},a.getDirections=function(){console.log("Getting directions!");var a=L.mapbox.directions();L.mapbox.directions.layer(a).addTo(k),L.mapbox.directions.errorsControl("errors",a).addTo(k),L.mapbox.directions.routesControl("routes",a).addTo(k),L.mapbox.directions.instructionsControl("instructions",a).addTo(k);a.setOrigin(g())},a.mapStyle={width:"100%"}}]);