/*! parking_app 2015-07-08 */
var app=angular.module("app",[]);app.controller("IndexController",["$scope","$http","$q",function(a,b,c){function d(){var b=new google.maps.LatLng(a.spot.latitude,a.spot.longitude);k=new google.maps.Map(document.getElementById("map-canvas"),{zoom:14,center:b,mapTypeId:google.maps.MapTypeId.ROADMAP})}a.auth=!1,a.tab=1,a.logIn=function(){b.post("/users/login",a.login).success(function(){e()})},a.register=function(){b.post("/users/register",a.login).success(function(){a.logIn()})},a.spot={},a.loading=!1;var e=function(){b.get("/users/username").success(function(b){b&&(a.user=b,a.auth=!0,a.user.spots[a.user.spots.length-1]&&o({latitude:a.user.spots[a.user.spots.length-1].latitude,longitude:a.user.spots[a.user.spots.length-1].longitude}))})},f=function(){var c={"user._id":a.user._id,spot:a.spot};return b.post("/spots/add/",c)},g=function(){var c={"user._id":a.user._id,spot:a.spot};return b.put("/spots/update",c)};a.park=function(){a.loading=!0;var b=h();b.then(function(b){o(a.spot),f();var c=new google.maps.LatLng(a.spot.latitude,a.spot.longitude);k.setCenter(c),k.setZoom(15),a.loading=!1},function(b){console.log("Failed: ",b),a.loading=!1})},a.route=function(){a.loading=!0;var b=h();b.then(function(b){p(),a.loading=!1},function(b){console.log("Failed: ",b),a.loading=!1})};var h=function(){return c(function(a,b){setTimeout(function(){1==j()?a("Position acquired"):b("Could not resolve position")},1e3)})},i=function(b){return a.spot.created=new Date,a.spot.latitude=b.coords.latitude,a.spot.longitude=b.coords.longitude,null==k&&d(),!0},j=function(){if(navigator.geolocation)return navigator.geolocation.getCurrentPosition(i),!0;throw new Error("In-browser geolocation not supported")};a.mapStyle={width:"100%"};var k,l=new google.maps.DirectionsService,m=new google.maps.DirectionsRenderer,n=new google.maps.Marker;google.maps.event.addDomListener(window,"load",j);var o=function(b){m.setMap(null),m.setPanel(null),n.setMap(null),n=new google.maps.Marker({position:new google.maps.LatLng(b.latitude,b.longitude),draggable:!0,animation:google.maps.Animation.DROP,title:"Parking Spot"}),google.maps.event.addListener(n,"dragend",function(){m.setMap(null),m.setPanel(null);var b=n.getPosition();a.spot.latitude=b.A,a.spot.longitude=b.F,a.spot.created=new Date,g(),j()}),n.setMap(k)},p=function(){var b=document.getElementById("directionsPanel");l.route({origin:new google.maps.LatLng(a.spot.latitude,a.spot.longitude),destination:n.position,travelMode:google.maps.TravelMode.WALKING},function(a,c){c==google.maps.DirectionsStatus.OK&&(m.setDirections(a),m.setMap(k),m.setPanel(b))})}}]);